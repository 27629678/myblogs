###4.0.1.469线上用户崩溃问题总结


#### 一、问题引入

线上部分用户随着4.0.1.469版本升级出现**`启动后直接Crash`**的现象，在不做版本升级或者重新安装4.0.1.469版本的情况下，无法彻底解决Crash的问题；

#### 二、问题重现

- 网络条件：网络联通率略低或网络延时较长
- 邮件账号：该账号没有CardDav服务器配置，例如：corp|139|tom等外域邮箱，并且账号下**`已发送`**的邮件夹中至少含有一封已经发送的邮件
- 应用版本：用户安装3.5.2.132后没有卸载重新安装App
- 重现步骤：
	1. 邮箱大师App(以后简称App)全新启动
	2. 在邮件列表出现后，立即右滑进入账号与邮件夹列表
	3. 选择`已发送`或系统语言为英语时`Sent`邮件夹进入
	4. 保持当前UI界面不动直到出现邮件列表接收到邮件并展示出来，即收集成功
	5. 此时数据库在没有意外的情况下必然出现脏数据，即相同联系人的信息出现多份
	6. 升级App到4.0.1.469, 升级完成后启动App，在第`5`条成功的情况下必现Crash的现象

#### 三、崩溃分析

App在全新启动后，首次收取收件箱邮件时会顺带收取**`已发送`**邮件夹中的邮件，执行重现步骤中的第三步之后，再次收取**`已发送`**邮件夹中的邮件。在网络条件满足的情况下，首次收取**`已发送`**邮件夹邮件的Callback没有回来之前，再次启动收取**`已发送`**邮件夹邮件的操作，此时收信流程的回调子程序会挂载两个Callback，导致收信成功后Callback执行两次，甚至多次。

此时，App内登录的账号若满足以上账号条件，则将**`已发送`**邮件夹中邮件里的联系人保存至通讯录中。从而导致第五步骤中，数据中出现了脏数据。

在3.5.2版本之后的3.6.1版本，我们做了App数据库升级。由于数据库升级子程序存在Bug，即一个同名联系人下有多条邮件地址升级后保存为多个联系人，相同联系人ID（contact_id)下出现不同名称的脏数据存在。

在4.0.1版本中，我们对通讯录做了优化——自动合并重复联系人，该流程在App启动之后，收信流程完成后自动同步通讯录，同步通讯录流程最后一个步骤进行通讯录自动合并操作。该操作在数据库数据正常，即没有脏数据的情况下可以正常工作。若数据库出现了脏数据的用户表现为启动后几秒钟后Crash，若此时网络无法联通不会Crash。