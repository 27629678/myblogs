####一、问题引出

当前邮箱大师（还有网易邮箱、邮箱大师Pro）有三个target，分别对应开发、提测和商店版本；

由于不同时期，服务器提供的接口可能是测试接口、beta接口及线上稳定接口不等，为了开发和测试的时候，便于快速修改WebService接口，而不是采用重新打包的方法，提出了为应用提供一个测试工具，**`MailTool`**（配置文件管理工具，以下简称**工具**）应运而生。

该工具主要包含：配置文件的设置与查看、功能的开启与关闭及日志文件的导出及级别等；
**工具**是一个独立的应用程序，通过`url_scheme`与邮箱大师进行数据的交换，大体与微信、微博及易信的分享SDK相似；

####二、QA需求：

1. 启动页相关
    - 启动页优先级（高校/VIP/广告/企业邮）查看和配置；
    - 广告（投放周期、显示时间、资源URL、广告模式及跳转链接）的查看和配置；
    - 高校/VIP/企业邮启动页查看和配置以及下线；
    - 等；
2. 开关相关
    - 大师有礼等活动URL、活动开关、红点开关的查看和配置；
    - 提示更新模式开关、版本号的查看和配置；
    - Gmail OAuth开关的查看和配置；
    - 用户好评开关查看和配置；
    - QQ登录破解开关查看和配置；
    - 签名替换小尾巴开关查看和配置；
    - 等；
3. 测试服/线上服切换；
	- WZP；
	- 大师云；
	- 通讯录；
   	- 等；
4. 清除本地所有配置荐；
5. 未完待补充；

####三、设计分析：

#####3.1、大体分为以下几个模块：

- 数据处理模块；
- 请求与响应指令包处理模块；
- 其它附属模块；

>备注：附属模块也许是最麻烦的一个模块，所有功能的完成，需要邮箱大师客户端与工具两端同时开发才可以完美支持；

#####3.2、数据处理

数据处理分三种情况：

- 临时配置文件加载；
- 内存对象序列化与反序列化；
- 实时指令处理；

#####3.3、Request与Response指令包的处理

引入MTUSDK(MailTestUtilSDK的缩写，以下简称**SDK**），用它实现邮箱大师与工具进程间通信，指令与数据的传递；

#####3.4、其它附属模块

邮箱大师应用内的附属模块用于响应测试工具发出的**Request**指令及将处理后数据打包作为**Response**指令的一部分返回给测试工具做进一步处理，如展示当前邮箱大师基本信息、配置和开关状态等；

1. `NEJsonModel`模块用于将内存对象反序列化为`Json`字符串，或者将`Json`字符串序列化为内存对象；
2. `NEConfigEngine`模块用于实现本地WebService接口配置数据的获取及开关属性的开启与闭合查询功能；
3. `NEMtuInteractionManager`模块用于处理`SDK`解析出来的指令及数据并做出反馈响应包给**工具**使用；

####四、安全性考虑

若将配置文件置于bundle外部，即用户目录，每次读取都要进行加密和解密操作及数据完整性检查，代码相对比较高，可维护性差（开发人员看到配置文件在没有经过处理的情况下，看不到解密后的文件内容）；

若将配置文件置于bundle内部，不便于修改配置文件；

基于以上两种极端方案，以下采取了相对保守的方式，默认的配置文件置于bundle内，增量添加的配置信息置于用户目录下。方案的特点：

- 免去了加解密和数据一致性检查的步骤
- 运行时加速了配置项的访问

另外，**Request**指令的发出只能从**工具**端发出，这样保证了邮箱大师只能被动的接受处理请求并做出响应即可，从而避免了类似微博淘宝等应用程序在商店包中开放了测试入口的囧境。


####五、运行效果

